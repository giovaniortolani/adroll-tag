___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "AdRoll",
  "brand": {
    "id": "brand_dummy",
    "displayName": "stape-io",
    "thumbnail": "data:image/png;base64,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\u003d\u003d"
  },
  "description": "",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "RADIO",
    "name": "eventType",
    "displayName": "Event Name Setup Method",
    "radioItems": [
      {
        "value": "standard",
        "displayValue": "Standard",
        "subParams": [
          {
            "type": "SELECT",
            "name": "eventNameStandard",
            "selectItems": [
              {
                "value": "pageView",
                "displayValue": "Page View"
              },
              {
                "value": "productSearch",
                "displayValue": "Product Search"
              },
              {
                "value": "addToCart",
                "displayValue": "Add to Cart"
              },
              {
                "value": "purchase",
                "displayValue": "Purchase"
              }
            ],
            "simpleValueType": true,
            "defaultValue": "pageView",
            "displayName": "Event Name",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "alwaysInSummary": true
          }
        ]
      },
      {
        "value": "inherit",
        "subParams": [],
        "displayValue": "Inherit from client"
      },
      {
        "value": "custom",
        "subParams": [
          {
            "type": "TEXT",
            "name": "eventNameCustom",
            "displayName": "",
            "simpleValueType": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          }
        ],
        "displayValue": "Custom"
      }
    ],
    "simpleValueType": true,
    "defaultValue": "standard"
  },
  {
    "type": "TEXT",
    "name": "advertisableId",
    "displayName": "Advertisable ID",
    "simpleValueType": true,
    "help": "You can find it \u003ca href\u003d\"https://app.adroll.com/segments\" target\u003d\"_blank\"\u003ehere\u003c/a\u003e under \u003ci\u003eAdRoll \u003e Website \u003e View Pixel \u003e adroll_adv_id\u003c/i\u003e.",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "pixelId",
    "displayName": "Pixel ID",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "help": "You can find it \u003ca href\u003d\"https://app.adroll.com/segments\" target\u003d\"_blank\"\u003ehere\u003c/a\u003e under \u003ci\u003eAdRoll \u003e Website \u003e View Pixel \u003e adroll_pix_id\u003c/i\u003e."
  },
  {
    "type": "TEXT",
    "name": "accessToken",
    "displayName": "Access Token",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "help": "[TO DO]"
  },
  {
    "type": "TEXT",
    "name": "itemIdKey",
    "displayName": "Custom Item Id Key",
    "simpleValueType": true,
    "help": "You can specify a custom key, which will be used to set the content item id, by default \u003ci\u003eitem_id\u003c/i\u003e will be used. This may be useful if you are using WooCommerce extensions.",
    "canBeEmptyString": true
  },
  {
    "type": "CHECKBOX",
    "name": "testMode",
    "checkboxText": "Test Mode",
    "simpleValueType": true,
    "help": "If checked, the event will not be recorded but the API will still return the same response messages. Use this mode to verify your requests are working and your events are constructed correctly."
  },
  {
    "type": "CHECKBOX",
    "name": "useOptimisticScenario",
    "checkboxText": "Use Optimistic Scenario",
    "simpleValueType": true,
    "help": "The tag will call gtmOnSuccess() without waiting for a response from the API. This will speed up sGTM response time however your tag will always return the status fired successfully even in case it is not."
  },
  {
    "type": "CHECKBOX",
    "name": "overrideCookieDomain",
    "checkboxText": "Override the cookie domain",
    "simpleValueType": true,
    "subParams": [
      {
        "type": "TEXT",
        "name": "overridenCookieDomain",
        "displayName": "Cookie Domain",
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "overrideCookieDomain",
            "paramValue": true,
            "type": "EQUALS"
          }
        ],
        "help": "",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "valueHint": "example.com"
      }
    ],
    "help": "Enable this option to override the cookie domain.\n\u003cbr\u003e\nEnter your website\u0027s top-level domain as a fixed value (e.g., example.com).\n\u003cbr\u003e\nIf left unchecked, the domain will be automatically determined using the following priority:\n\u003cul\u003e\n\u003cli\u003eDomain of the \u003ci\u003eForwarded\u003c/i\u003e header (if present).\u003c/li\u003e\n\u003cli\u003eDomain of the \u003ci\u003eX-Forwarded-Host\u003c/i\u003e header (if present).\u003c/li\u003e\n\u003cli\u003eDomain of the \u003ci\u003eHost\u003c/i\u003e header.\u003c/li\u003e\n\u003c/ul\u003e"
  },
  {
    "displayName": "Server Parameters",
    "name": "serverDataListGroup",
    "groupStyle": "ZIPPY_CLOSED",
    "type": "GROUP",
    "subParams": [
      {
        "type": "SIMPLE_TABLE",
        "name": "serverDataList",
        "displayName": "",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "Name",
            "name": "name",
            "type": "SELECT",
            "selectItems": [
              {
                "value": "page_location",
                "displayValue": "Page Location"
              },
              {
                "value": "timestamp",
                "displayValue": "Timestamp"
              }
            ],
            "isUnique": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          },
          {
            "defaultValue": "",
            "displayName": "Value",
            "name": "value",
            "type": "TEXT",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          }
        ],
        "newRowButtonText": "Add property"
      }
    ]
  },
  {
    "displayName": "User Data Parameters",
    "name": "userDataListGroup",
    "groupStyle": "ZIPPY_CLOSED",
    "type": "GROUP",
    "subParams": [
      {
        "name": "userDataList",
        "simpleTableColumns": [
          {
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "defaultValue": "",
            "displayName": "Property Name",
            "name": "name",
            "isUnique": true,
            "type": "SELECT",
            "selectItems": [
              {
                "value": "email",
                "displayValue": "Email"
              },
              {
                "value": "deviceId",
                "displayValue": "Device ID (?)"
              },
              {
                "value": "first_party_cookie",
                "displayValue": "Browser ID (\"__adroll_fpc\" cookie value)"
              },
              {
                "value": "adct",
                "displayValue": "Click ID (\"adct\" URL parameter value)"
              },
              {
                "value": "user_id",
                "displayValue": "User ID"
              },
              {
                "value": "ip",
                "displayValue": "Client IP Address"
              },
              {
                "value": "user_agent",
                "displayValue": "Client IP User Agent"
              }
            ]
          },
          {
            "defaultValue": "",
            "displayName": "Property Value",
            "name": "value",
            "type": "TEXT",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          }
        ],
        "type": "SIMPLE_TABLE",
        "newRowButtonText": "Add property"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "appDeviceDataListGroup",
    "displayName": "App/Device Data Parameters",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "SIMPLE_TABLE",
        "name": "appDeviceDataList",
        "displayName": "",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "Name",
            "name": "name",
            "type": "SELECT",
            "isUnique": true,
            "selectItems": [
              {
                "value": "package_app_name",
                "displayValue": "App Package Name"
              },
              {
                "value": "package_app_version",
                "displayValue": "App Package Version"
              },
              {
                "value": "device_os",
                "displayValue": "Operating System"
              },
              {
                "value": "device_type",
                "displayValue": "Device Type"
              }
            ],
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          },
          {
            "defaultValue": "",
            "displayName": "Value",
            "name": "value",
            "type": "TEXT",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          }
        ],
        "newRowButtonText": "Add property"
      }
    ]
  },
  {
    "displayName": "Custom Data Parameters",
    "name": "customDataListGroup",
    "groupStyle": "ZIPPY_CLOSED",
    "type": "GROUP",
    "subParams": [
      {
        "type": "LABEL",
        "name": "сustomDataLabel",
        "displayName": "[TO DO] See \u003ca href\u003d\"\" target\u003d\"_blank\"\u003ethis documentation\u003c/a\u003e for more details on what data parameters you can add to the call."
      },
      {
        "name": "customDataList",
        "simpleTableColumns": [
          {
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "defaultValue": "",
            "displayName": "Property Name",
            "name": "name",
            "isUnique": true,
            "type": "TEXT"
          },
          {
            "defaultValue": "",
            "displayName": "Property Value",
            "name": "value",
            "type": "TEXT"
          }
        ],
        "type": "SIMPLE_TABLE",
        "newRowButtonText": "Add property"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "consentSettingsGroup",
    "displayName": "Consent Settings",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "RADIO",
        "name": "adStorageConsent",
        "displayName": "",
        "radioItems": [
          {
            "value": "optional",
            "displayValue": "Send data always"
          },
          {
            "value": "required",
            "displayValue": "Send data in case marketing consent given"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "optional"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "logsGroup",
    "displayName": "Logs Settings",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "RADIO",
        "name": "logType",
        "radioItems": [
          {
            "value": "no",
            "displayValue": "Do not log"
          },
          {
            "value": "debug",
            "displayValue": "Log to console during debug and preview"
          },
          {
            "value": "always",
            "displayValue": "Always log to console"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "debug"
      }
    ]
  }
]


___SANDBOXED_JS_FOR_SERVER___

const getRequestHeader = require('getRequestHeader');
const getAllEventData = require('getAllEventData');
const setCookie = require('setCookie');
const getCookieValues = require('getCookieValues');
const encodeUriComponent = require('encodeUriComponent');
const makeString = require('makeString');
const makeInteger = require('makeInteger');
const sendHttpRequest = require('sendHttpRequest');
const JSON = require('JSON');
const logToConsole = require('logToConsole');
const generateRandom = require('generateRandom');
const getTimestampMillis = require('getTimestampMillis');
const getContainerVersion = require('getContainerVersion');
const parseUrl = require('parseUrl');
const Math = require('Math');

/**********************************************************************************************/

const isLoggingEnabled = determinateIsLoggingEnabled();
const traceId = isLoggingEnabled ? getRequestHeader('trace-id') : undefined;

const eventData = getAllEventData();

if (!isConsentGivenOrNotRequired()) {
  return data.gtmOnSuccess();
}

const url = eventData.page_location || getRequestHeader('referer');

if (url && url.lastIndexOf('https://gtm-msr.appspot.com/', 0) === 0) {
  return data.gtmOnSuccess();
}

const mappedEventData = mapEvent(eventData, data);

setCookiesIfNeeded(mappedEventData);

sendTrackRequest(mappedEventData);

if (data.useOptimisticScenario) {
  data.gtmOnSuccess();
}

/**********************************************************************************************/
// Vendor related functions

function getPostUrl() {
  return 'https://srv.adroll.com/api?' +
    'advertisable=' + enc(data.advertisableId) +
    '&dry_run=' + (data.testMode ? '1' : '0');
}

function sendTrackRequest(mappedEventData) {
  const postBody = mappedEventData;
  const postUrl = getPostUrl();
  
  if (isLoggingEnabled) {
    logToConsole(
      JSON.stringify({
        Name: 'Adroll',
        Type: 'Request',
        TraceId: traceId,
        EventName: mappedEventData.event_name,
        RequestMethod: 'POST',
        RequestUrl: postUrl,
        RequestBody: postBody
      })
    );
  }
  
  sendHttpRequest(
    postUrl,
    (statusCode, headers, body) => {
      logToConsole({
        Name: 'Adroll',
        Type: 'Response',
        TraceId: traceId,
        EventName: mappedEventData.event_name,
        ResponseStatusCode: statusCode,
        ResponseHeaders: headers,
        ResponseBody: body,
      });

      if (!data.useOptimisticScenario) {
        if (statusCode >= 200 && statusCode < 400) {
          data.gtmOnSuccess();
        } else {
          data.gtmOnFailure();
        }
      }
    },
    {
      headers: {
        'Authorization': 'token ' + data.accessToken,
        'Content-Type': 'application/json'
      },
      method: 'POST'
    },
    JSON.stringify(postBody)
  );
}

function getEventName(eventData, data) {
  if (data.eventType === 'inherit') {
    let eventName = eventData.event_name;

    let gaToEventName = {
      page_view: 'pageView',
      'gtm.dom': 'pageView',
      search: 'productSearch',
      view_search_results: 'productSearch',
      view_item_list: 'productSearch',
      add_to_cart: 'addToCart',
      complete_registration: 'purchase',
      sign_up: 'purchase',
      generate_lead: 'purchase',
      purchase: 'purchase',
      
      'gtm4wp.addProductToCartEEC': 'addToCart',
      'gtm4wp.orderCompletedEEC': 'purchase',
    };

    if (!gaToEventName[eventName]) {
      return eventName;
    }

    return gaToEventName[eventName];
  }

  return data.eventType === 'standard' ? data.eventNameStandard : data.eventNameCustom;
}

function mapEvent(eventData, data) {
  let mappedData = {
    advertisable_eid: data.advertisableId,
    pixel_eid: data.pixelId,
    event_name: getEventName(eventData, data),
    event_attributes: {},
    identifiers: {},
  };

  mappedData = addServerData(eventData, mappedData);
  mappedData = addUserData(eventData, mappedData);
  mappedData = addAppDeviceData(eventData, mappedData);
  mappedData = addCustomData(eventData, mappedData);
  // mappedData = hashDataIfNeeded(mappedData);

  return mappedData;
}

function addServerData(eventData, mappedData) {
  if (eventData.page_location) mappedData.page_location = eventData.page_location;

  if (eventData.timestamp) mappedData.timestamp = eventData.timestamp;
  else mappedData.timestamp = Math.round(getTimestampMillis() / 1000);
  
  // Override with user input data from template fields.
  if (data.serverDataList) {
    data.serverDataList.forEach((d) => {
      mappedData[d.name] = d.value;
    });
  }
  
  return mappedData;
}

function addUserData(eventData, mappedData) {
  const user_data = eventData.user_data || {};
  
  const clickId = getClickId();
  if (clickId) mappedData.identifiers.adct = clickId;
  
  const browserId = getBrowserId();
  if (browserId) mappedData.identifiers.first_party_cookie = browserId;
  
  if (eventData.email) mappedData.identifiers.email = eventData.email;
  else if (user_data.email_address) mappedData.identifiers.email = user_data.email_address;
  else if (user_data.email) mappedData.identifiers.email = user_data.email;
  
  if (eventData.external_id) mappedData.identifiers.user_id = eventData.external_id;
  else if (eventData.user_id) mappedData.identifiers.user_id = eventData.user_id;
  else if (eventData.userId) mappedData.identifiers.user_id = eventData.userId;
  
  // TO DO
  // Add 'device_id' - What is the expected 'device_id'?
  
  if (eventData.ip_override) {
    mappedData.ip = eventData.ip_override.split(' ').join('').split(',')[0];
  }
  
  if (eventData.user_agent) mappedData.user_agent = eventData.user_agent;

  // Override with user input data from template fields.
  if (data.userDataList) {
    data.userDataList.forEach((d) => {
      // IP and User Agent go in the root level of the object.
      if (['ip', 'user_agent'].includes(d.name)) mappedData[d.name] = d.value;
      else mappedData.identifiers[d.name] = d.value;
    });
  }
  
  return mappedData;
}

function addAppDeviceData(eventData, mappedData) {
  if (eventData.device_os) mappedData.device_os = eventData.device_os;
  else if (eventData['x-ga-platform']) mappedData.device_os = eventData['x-ga-platform']; // Firebase events
  
  if (eventData.device_type) mappedData.device_type = eventData.device_type;
  
  if (eventData.package_app_name) mappedData.package_app_name = eventData.package_app_name;
  else if (eventData.app_id) mappedData.package_app_name = eventData.app_id; // Firebase events
  
  if (eventData.package_app_version) mappedData.package_app_version = eventData.package_app_version;
  else if (eventData.app_version) mappedData.package_app_version = eventData.app_version; // Firebase events
  
  // Override with user input data from template fields.
  if (data.appDeviceDataList) {
    data.appDeviceDataList.forEach((d) => {
      mappedData[d.name] = d.value;
    });
  }
  
  return mappedData;
}

function addCustomData(eventData, mappedData) {
/*
  'event_attributes': None, // Object (with nested objects and array) 
    // { 
         [?] total: '56.78'  // Item value or cart value (Does it make sense since there's already the 'conversion_value' in the level above?)
         [?] keywords: ''    // Does it make sense since there's already the 'keyword' in the level above?
         [?] user_id: ''     // Does it make sense since there's already 'user_id' in the 'identifiers' object in the level above?
       }
*/
  let currencyFromItems = '';
  let valueFromItems = 0;
  
  if (eventData.items && eventData.items[0]) {
    mappedData.event_attributes.products = [];
    currencyFromItems = eventData.items[0].currency;

    const itemIdKey = data.itemIdKey ? data.itemIdKey : 'item_id';
    eventData.items.forEach((d, i) => {
      let content = {};
      if (d[itemIdKey]) content.product_id = makeString(d[itemIdKey]);
      if (d.quantity) content.quantity = makeInteger(d.quantity);
      if (d.item_category) content.item_category = d.item_category;
      if (d.product_group) content.quantity = d.product_group;
      if (d.price) {
        content.price = makeString(d.price);
        valueFromItems += d.quantity ? d.quantity * d.price : d.price;
      }
      mappedData.event_attributes.products[i] = content;
    });
  }
  
  if (eventData['x-ga-mp1-ev']) mappedData.conversion_value = eventData['x-ga-mp1-ev'];
  else if (eventData['x-ga-mp1-tr']) mappedData.conversion_value = eventData['x-ga-mp1-tr'];
  else if (eventData.value) mappedData.conversion_value = eventData.value;
  else if (valueFromItems) mappedData.conversion_value = valueFromItems;
  
  if (eventData.currency) mappedData.currency = eventData.currency;
  else if (currencyFromItems) mappedData.currency = currencyFromItems;
  
  if (eventData.search_term) mappedData.keyword = eventData.search_term;
  
  if (eventData.transaction_id) mappedData.event_attributes.order_id = eventData.transaction_id;
  
  if (data.customDataList) {
    data.customDataList.forEach((d) => {
      // 'products' and 'order_id' go in the 'event_attributes' object.
      if (['products', 'order_id'].includes(d.name)) mappedData.event_attributes[d.name] = d.value;
      mappedData[d.name] = d.value;
    });
  }
  
  return mappedData;
}

function getClickId () {
  const searchParams = parseUrl(url).searchParams;
  if (searchParams && searchParams.adct) return searchParams.adct;
  const commonCookie = eventData.commonCookie || {};
  return eventData.adct || commonCookie.adct || getCookieValues('__adroll_adct')[0];
}

function getBrowserId () {
  const commonCookie = eventData.commonCookie || {};
  return getCookieValues('__adroll_fpc')[0] || eventData.__adroll_fpc || commonCookie.__adroll_fpc || generateBrowserId();
}

function generateBrowserId() {
  const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
  let result = '';

  for (let i = 0; i < 32; i++) {
    const randomIndex = generateRandom(0, characters.length - 1);
    result += characters.charAt(randomIndex);
  }
  
  result += '-' + getTimestampMillis();
  return result;
}

function setCookiesIfNeeded(eventData) {
  const cookieOptions = {
    domain: data.overridenCookieDomain || 'auto',
    path: '/',
    samesite: 'Lax',
    secure: true,
    'max-age': 31536000, // 365 days
    httpOnly: false,
  };
  
  // "__adroll_adct" cookie creation. It contains the value of the "adct" query parameter (Click ID).
  // Not sure if the cookie have this name or not. Need to confirm it.
  if (eventData.identifiers && eventData.identifiers.adct) {
    setCookie('__adroll_adct', eventData.identifiers.adct, cookieOptions);
  }
  
  // "__adroll_fpc" cookie creation. It contains the value of the Browser ID.
  if (eventData.identifiers && eventData.identifiers.first_party_cookie) {
    setCookie('__adroll_fpc', eventData.identifiers.first_party_cookie, cookieOptions);
  }
}

// function hashDataIfNeeded() {}

/**********************************************************************************************/
// Helpers

function enc(data) {
  data = data || '';
  return encodeUriComponent(makeString(data));
}

function isConsentGivenOrNotRequired() {
  if (data.adStorageConsent !== 'required') return true;
  if (eventData.consent_state) return !!eventData.consent_state.ad_storage;
  const xGaGcs = eventData['x-ga-gcs'] || ''; // x-ga-gcs is a string like "G110"
  return xGaGcs[2] === '1';
}

function determinateIsLoggingEnabled() {
  const containerVersion = getContainerVersion();
  const isDebug = !!(
    containerVersion &&
    (containerVersion.debugMode || containerVersion.previewMode)
  );

  if (!data.logType) {
    return isDebug;
  }

  if (data.logType === 'no') {
    return false;
  }

  if (data.logType === 'debug') {
    return isDebug;
  }

  return data.logType === 'always';
}


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "read_container_data",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_request",
        "versionId": "1"
      },
      "param": [
        {
          "key": "headerWhitelist",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "trace-id"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "referer"
                  }
                ]
              }
            ]
          }
        },
        {
          "key": "headersAllowed",
          "value": {
            "type": 8,
            "boolean": true
          }
        },
        {
          "key": "requestAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "headerAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "queryParameterAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_event_data",
        "versionId": "1"
      },
      "param": [
        {
          "key": "eventDataAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_http",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://srv.adroll.com/api/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "all"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "cookieNames",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "__adroll_fpc"
              },
              {
                "type": 1,
                "string": "__adroll_adct"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "set_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedCookies",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "__adroll_fpc"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "__adroll_adct"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 2/20/2025, 10:34:10 AM


